# RT/NTS -- a lightweight, high performance news transit server.
# 
# Copyright (c) 2011-2013 River Tarnell.
#
# Permission is granted to anyone to use this software for any purpose,
# including commercial applications, and to alter it and redistribute it
# freely. This software is provided 'as-is', without any express or implied
# warranty.

.SUFFIXES: .c .y .l .o .d .h

top_srcdir	= @top_srcdir@
prefix		= @prefix@
exec_prefix	= @exec_prefix@
bindir		= @bindir@
sbindir		= @sbindir@
sysconfdir	= @sysconfdir@

VPATH		= ${top_srcdir}:${top_srcdir}/client

CC		= @CC@
MAKEDEPEND	= @CC@ -MM
INSTALL		= @INSTALL@
CFLAGS		= @CFLAGS@
LDFLAGS		= @LDFLAGS@
CPPFLAGS	= @CPPFLAGS@ -I@top_srcdir@ -I.	\
		  -DSYSCONFDIR=\"@sysconfdir@\"
LIBS		= @LIBS@

YACC		= @YACC@
LEX		= @LEX@

SRCS		= nts.c		config.c	net.c		client.c	\
		  server.c	spool.c		log.c		article.c	\
		  history.c	database.c	hash.c				\
		  crc.c		wildmat.c	filter.c	feeder.c	\
		  charq.c	rfile.c		balloc.c	auth.c		\
		  crypt.c	strlcpy.c	thread.c	emp.c		\
		  dns.c		base64.c					\
		  client_authinfo.c	client_mode.c	client_listen.c		\
		  client_pending.c	client_reader.c	client_capab.c		\
		  client_check.c	client_ihave.c	client_help.c		\
		  client_tls.c		client_takethis.c			\
		  client_quit.c							\
		  incoming.c

EXTRA_SRCS	= @EXTRA_SRCS@
OBJS		= ${SRCS:.c=.o} ${EXTRA_SRCS:.c=.o}

HDRS		= article.h config.h database.h filter.h history.h net.h	\
		  client.h crc.h feeder.h hash.h log.h nts.h server.h		\
		  spool.h wildmat.h queue.h charq.h rfile.h balloc.h auth.h	\
		  crypt.h thread.h emp.h dns.h base64.h
EXTRA_DIST	= Makefile.in nts.conf.example parser.y lexer.l setup.h.in	\
		  configure.ac configure LICENSE strlcpy.c 
all: nts

dist:
	@version=`sed -n 's/^AC_INIT(\[[^]]*\], \[\([^]]*\)\], \[[^]]*\])$$/\1/p' \
	    		configure.ac`;						\
	rm -rf nts-$$version;							\
	mkdir nts-$$version;							\
	cp ${SRCS} ${HDRS} ${EXTRA_DIST} nts-$$version/;			\
	tar cf nts-$$version.tar nts-$$version;					\
	gzip -f nts-$$version.tar;						\
	ls -l nts-$$version.tar.gz

nts: $(OBJS) y.tab.o lex.yy.o
	$(CC) $(CFLAGS) $(LDFLAGS) $(OBJS) y.tab.o lex.yy.o -o nts $(LIBS)

install:
	${INSTALL} -d ${sbindir}
	${INSTALL} -m 0755 nts ${sbindir}
	${INSTALL} -d ${sysconfdir}
	${INSTALL} -m 0644 ${top_srcdir}/nts.conf.example ${sysconfdir}
	if ! test -e ${sysconfdir}/nts.conf; then	\
		cp ${sysconfdir}/nts.conf.example	\
			${sysconfdir}/nts.conf;		\
	fi

y.tab.c: parser.y
	$(YACC) -d @top_srcdir@/parser.y

y.tab.h: y.tab.c

lex.yy.c: lexer.l
	$(LEX) @top_srcdir@/lexer.l

lex.yy.o: lex.yy.c y.tab.h
	$(CC) $(CPPFLAGS) $(CFLAGS) -c lex.yy.c

.c.o:
	$(CC) $(CPPFLAGS) $(CFLAGS) -c $<

.c.d:
	$(MAKEDEPEND) $(CPPFLAGS) $< -o $@

clean:
	rm -f nts $(OBJS) $(SRCS:.c=.d)  lex.yy.c lex.yy.o y.tab.o y.tab.h y.tab.c

depend: $(SRCS:.c=.d)
	sed '/^# Do not remove this line -- make depend needs it/,$$ d' \
			<Makefile >Makefile.new
	echo '# Do not remove this line -- make depend needs it' >>Makefile.new
	cat *.d >> Makefile.new
	mv Makefile.new Makefile

.PHONY: depend clean install

# Do not remove this line -- make depend needs it
